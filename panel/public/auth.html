<!DOCTYPE html>
<html lang="zh-Hans-CN">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width">
  <meta name="keywords" content="JSTOOLæ·»åŠ è´¦å·">
  <meta name="description" content="JSTOOLæ·»åŠ è´¦å·">
  <meta name="viewport" content="width=device-width, initial-scale=1.0 ,user-scalable=no">
  <title>JSTOOLæ§åˆ¶é¢æ¿</title>
  <script type="text/javascript" src="./js/jquery.min.js"></script>
  <script type="text/javascript" src="./js/sweetalert2.js"></script>
  <link rel="stylesheet" type="text/css" href="./css/main2.css">
  <link href="./css/layui.css" rel="stylesheet" type="text/css">
  <link href="./css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="./css/index_style.css" rel="stylesheet" type="text/css">
  <link href="./css/animate.min.css" rel="stylesheet" type="text/css">
  <link rel="icon" type="image/x-icon" href="https://gitee.com/favicon.ico" />

  <div class="section" id="section1">
    <div class="fp-tablecell">
      <div class="page1">
        <div class="nav animated">
          <div class="login-form">
            <h1>JSTOOLæ§åˆ¶é¢æ¿</h1>
            <br>
            <br>
            <form action="auth" method="POST">
              <input type="text" name="username" class="username" placeholder="ç”¨æˆ·å" required>
              <input type="password" name="password" class="password" placeholder="å¯†ç " required>
              <br>
              <input class="layui-btn layui-btn-normal" type="submit" id="login" value="ç™»å½•">
            </form>
          </div>
        <div style="margin-top: 336px">
          <button class="layui-btn layui-btn-normal" style="margin: auto" id="qrcode">æ‰«ç æ·»åŠ è´¦å·</button>
          <button class="layui-btn layui-btn-normal" style="margin: auto" id="jumpapp">æ‰“å¼€APPæ·»åŠ </button>
          <a class="layui-btn layui-btn-normal" style="margin: auto" href="./BeanChange.html">èµ°åŠ¿å›¾</a>
          <br>
          <a class="layui-btn layui-btn-normal"  style="margin-left: auto" href="https://jq.qq.com/?_wv=1027&k=">JSTOOLäº¤æµè£™</a>
          <input id="msg" style="width: 0px;height:0px;" type="text" placeholder=""/>
          <button class="layui-btn layui-btn-normal" style="width: 0px;height:0px;" id="jdcode"></button>
        </div>
        </div>
        <script src="./js/qrcode.min.js"></script>
        <style type="text/css">
          body,
          html {
            margin: 0;
            padding: 0;
          }

          .title {
            padding-top: 150px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            color: red;
            box-sizing: border-box;
          }

          #msg {
            display: block;
            width: 90%;
            height: 30px;
            border-width: 2px;
            border-radius: 5px;
            margin: 0 auto;
          }

          .container {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: calc(100vh - 430px);
          }

          .btn {
            margin: 0 auto;
            border: 1px #3079ed solid;
            border-radius: 5px;
            font-size: 32pt;
            background: #4c8ffb;
            color: white;
          }

          .qr {
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: center;
            inset: 0px;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45);
            z-index: 1001;
          }

          .qrcontainer {
            position: relative;
            width: 256px;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgb(109, 138, 136);
            background-color: rgb(255, 255, 255);
            box-shadow: rgb(0 0 0 / 20%) 0px 0px 7px 3px;
            box-sizing: content-box;
          }

          #tip {
            display: none;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 16px;
            left: 16px;
            width: 256px;
            height: 256px;
            color: rgb(255, 255, 255);
            background-color: rgba(0, 0, 0, 0.5);
          }

          .des {
            word-break: break-word;
            padding-top: 16px;
          }
        </style>
</head>

<body>
  <div id="qr" class="qr">
    <div class="qrcontainer">
      <div id="qrbox"></div>
      <div id="tip">
        <h3>äºŒç»´ç å·²å¤±æ•ˆ</h3>
      </div>
      <div id="des" class="des">
        è¯·ä½¿ç”¨äº¬ä¸œAPPæ‰«ç <br />æˆ–æˆªå›¾ç”¨äº¬ä¸œAPPæ‰«ç <br />å®Œæˆåè¯·å›åˆ°æ­¤é¡µé¢å¤åˆ¶cookie<br />è¯·æ— è§†å‡çº§æç¤º
      </div>
    </div>
  </div>
  <div id="res" class="qr">
    <div class="qrcontainer">
      <div id="cookie" class="des"></div>
    </div>
  </div>
</body>
<script>
  $.ajaxSetup({
    cache: false
  });

  $("#login").click(function () {
    $user = $(".username").val();
    $password = $(".password").val();
    if (!$user || !$password) return;

    $.post('./auth', {
      username: $user,
      password: $password
    }, function (data) {
      if (data.err == 0) {
        window.location.href = "./usrconfig";
      } else {
        Swal.fire({
          text: data.msg,
          icon: 'error'
        })
      }
    });
    return false;
  });

  get_code();
  var jdCode = '';
  var loginUrl = '';
  var resDiv = document.getElementById('res');
  document.getElementById('jdcode').addEventListener('click', function () {
    if (jdCode) {
      copyText(jdCode);
      alert('å¤åˆ¶æˆåŠŸï¼Œè¯·åœ¨äº¬ä¸œä¸­æ‰“å¼€');
      window.open('openapp.jdmobile://');
    } else {
      alert('è¿˜æ²¡åŠ è½½å¥½ï¼Œè¯·ç¨åé‡è¯•');
    }
  });
  document.getElementById('jumpapp').addEventListener('click', function () {
    if (loginUrl) {
      window.location.href = `openapp.jdmobile://virtual/ad?params=${encodeURI(
        JSON.stringify({
          category: 'jump',
          des: 'ThirdPartyLogin',
          action: 'to',
          onekeylogin: 'return',
          url: loginUrl,
          authlogin_returnurl: 'weixin://',
          browserlogin_fromurl: window.location.host,
        })
      )}`;
    } else {
      alert('è¿˜æ²¡åŠ è½½å¥½ï¼Œè¯·ç¨åé‡è¯•');
    }
  });
  document.getElementById('qrcode').addEventListener('click', function () {
    if (loginUrl) {
      document.getElementById('qr').style.display = 'flex';
    } else {
      alert('è¿˜æ²¡åŠ è½½å¥½ï¼Œè¯·ç¨åé‡è¯•');
    }
  });
  document.getElementById('qr').addEventListener('click', function (event) {
    if (event.target.id === 'qr') {
      document.getElementById('qr').style.display = 'none';
    }
  });
  function get_code() {
    let timeStamp = new Date().getTime();
    ajax({
      url: './qrcode?t=' + timeStamp,
      method: 'get',
      success: function (data) {
        if (data.err == 0) {
          checkLogin(data.user);
          //console.log('jdCode:' + data.jdCode);
          jdCode = data.jdCode;
          loginUrl = data.qrcode;
          qrbox = document.getElementById('qrbox');
          qrcode = new QRCode(qrbox, {
            text: loginUrl,
            correctLevel: QRCode.CorrectLevel.L,
          });
        }
      },
    });
  }
  function checkLogin(user) {
    time = setInterval(() => {
      let timeStamp = new Date().getTime();
      ajax({
        url: './cookie2?t=' + timeStamp,
        method: 'post',
        data: { user, msg: document.getElementById('msg').value || 'æ— å¤‡æ³¨' },
        success: function (data) {
          if (data.err == 0) {
            console.log('cookie:' + data.cookie);
            document.getElementById('qr').style.display = 'none';
            document.getElementById('res').style.display = 'flex';
            document.getElementById('cookie').innerHTML =
              '<span>' +
              document.getElementById('msg').value +
              '</span>' +
              'ğŸˆæ·»åŠ æˆåŠŸğŸˆ';
            /*  '<p>' +
              //data.cookie +
              //'</p><button id="copyToClip">å¤åˆ¶</button>';
            document.getElementById('copyToClip').onclick = function () {
              copyText(data.cookie);
              alert('å¤åˆ¶æˆåŠŸ');
            };
            */
            clearInterval(time);
            jdCode = '';
            loginUrl = '';
          } else if (data.err == 21) {
            document.getElementById('tip').style.display = 'flex';
            alert('äºŒç»´ç è¿‡æœŸ');
            clearInterval(time);
            jdCode = '';
            loginUrl = '';
          }
        },
      });
    }, 3000);
  }
  function copyText(text) {
    // æ•°å­—æ²¡æœ‰ .length ä¸èƒ½æ‰§è¡ŒselectText éœ€è¦è½¬åŒ–æˆå­—ç¬¦ä¸²
    var textString = text.toString();
    var input = document.querySelector('#copy-input');
    if (!input) {
      input = document.createElement('input');
      input.id = 'copy-input';
      input.readOnly = 'readOnly'; // é˜²æ­¢iosèšç„¦è§¦å‘é”®ç›˜äº‹ä»¶
      input.style.position = 'absolute';
      input.style.left = '-1000px';
      input.style.zIndex = '-1000';
      document.body.appendChild(input);
    }
    input.value = textString;
    // ioså¿…é¡»å…ˆé€‰ä¸­æ–‡å­—ä¸”ä¸æ”¯æŒ input.select();
    selectText(input, 0, textString.length);
    console.log(document.execCommand('copy'), 'execCommand');
    if (document.execCommand('copy')) {
      document.execCommand('copy');
      //alert('å·²å¤åˆ¶åˆ°ç²˜è´´æ¿');
    }
    input.blur();
    // inputè‡ªå¸¦çš„select()æ–¹æ³•åœ¨è‹¹æœç«¯æ— æ³•è¿›è¡Œé€‰æ‹©ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å»å†™ä¸€ä¸ªç±»ä¼¼çš„æ–¹æ³•
    // é€‰æ‹©æ–‡æœ¬ã€‚createTextRange(setSelectionRange)æ˜¯inputæ–¹æ³•
    function selectText(textbox, startIndex, stopIndex) {
      if (textbox.createTextRange) {
        //ie
        const range = textbox.createTextRange();
        range.collapse(true);
        range.moveStart('character', startIndex); //èµ·å§‹å…‰æ ‡
        range.moveEnd('character', stopIndex - startIndex); //ç»“æŸå…‰æ ‡
        range.select(); //ä¸å…¼å®¹è‹¹æœ
      } else {
        //firefox/chrome
        textbox.setSelectionRange(startIndex, stopIndex);
        textbox.focus();
      }
    }
  }
  function ajax(options) {
    var url = options.url;
    var method = options.method;
    var data = options.data;
    var success = options.success;
    var ajax = new XMLHttpRequest();
    ajax.open(method, url);
    if (method == 'post') {
      ajax.setRequestHeader('Content-type', 'application/json');
    }
    ajax.send(JSON.stringify(data));
    ajax.onreadystatechange = function () {
      if (ajax.readyState == 4 && ajax.status == 200) {
        success(JSON.parse(ajax.responseText));
      }
    };
  }
</script>

</html>